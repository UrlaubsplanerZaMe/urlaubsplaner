<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Urlaubsplaner</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
body { margin:0; }
#map { height:100vh; }

.card{
position:absolute; top:14px; left:14px; z-index:1000;
width:340px; background:rgba(255,255,255,0.95);
border-radius:18px; padding:14px;
box-shadow:0 16px 40px rgba(0,0,0,0.18);
font-family:-apple-system;
}
.field{width:100%;padding:12px;border-radius:12px;border:1px solid #ddd;margin-bottom:8px;}
.btn{padding:10px;border-radius:12px;border:0;font-weight:800;cursor:pointer;width:100%;}
.gray{background:#eee;}
.meta{font-size:13px;margin-top:8px;}
.row{display:flex;gap:6px;margin-bottom:8px;}
</style>
</head>
<body>

<div class="card">

<div class="row">
<button class="btn gray" onclick="setMapMode('start')">Start</button>
<button class="btn gray" onclick="setMapMode('stop')">Stopp</button>
<button class="btn gray" onclick="setMapMode('ziel')">Ziel</button>
</div>

<input id="startAddr" class="field" placeholder="Startadresse">

<div id="stops"></div>
<button class="btn gray" onclick="addStop()">+ Stopp</button>

<input id="endAddr" class="field" placeholder="Zieladresse">

<div class="meta" id="meta"></div>

</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const map = L.map('map').setView([51.1657,10.4515],6);
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

let mapMode=null;

function setMapMode(mode){ mapMode=mode; }

let startMarker,endMarker;
let stopItems=[];

function createMarker(latlng,label,onMove){
const m=L.marker(latlng,{draggable:true}).addTo(map).bindPopup(label);

m.on("dragend", async ()=>{
const p=m.getLatLng();
const addr=await reverseGeocode(p.lat,p.lng);
await onMove(addr);
buildRoute();
});

return m;
}

map.on("click", async e=>{
if(!mapMode) return;

const addr=await reverseGeocode(e.latlng.lat,e.latlng.lng);

if(mapMode==="start"){
startAddr.value=addr;
if(startMarker) map.removeLayer(startMarker);
startMarker=createMarker(e.latlng,"Start",a=>startAddr.value=a);
}

if(mapMode==="ziel"){
endAddr.value=addr;
if(endMarker) map.removeLayer(endMarker);
endMarker=createMarker(e.latlng,"Ziel",a=>endAddr.value=a);
}

if(mapMode==="stop"){
addStop(addr,e.latlng);
}

mapMode=null;
});

function addStop(prefill="",latlng=null){

const row=document.createElement("div");
row.style.display="flex"; row.style.gap="6px";

const input=document.createElement("input");
input.className="field";
input.value=prefill;

const del=document.createElement("button");
del.className="btn gray";
del.textContent="X";

row.appendChild(input);
row.appendChild(del);
stops.appendChild(row);

const item={input,marker:null};
stopItems.push(item);

del.onclick=()=>{
if(item.marker) map.removeLayer(item.marker);
stopItems=stopItems.filter(i=>i!==item);
row.remove();
buildRoute();
};

if(latlng){
item.marker=createMarker(latlng,"Stopp",a=>input.value=a);
}

input.onchange=buildRoute;
}

async function reverseGeocode(lat,lon){
const res=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
const data=await res.json();
return data.display_name || lat+","+lon;
}

async function geocode(q){
const res=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`);
const data=await res.json();
return data[0];
}

async function buildRoute(){

if(!startAddr.value || !endAddr.value) return;

const start=await geocode(startAddr.value);
const end=await geocode(endAddr.value);

let coords=[start];

for(const s of stopItems){
if(s.input.value){
coords.push(await geocode(s.input.value));
}
}

coords.push(end);

const c=coords.map(c=>`${c.lon},${c.lat}`).join(";");

const res=await fetch(`https://router.project-osrm.org/route/v1/driving/${c}?overview=full&geometries=geojson`);
const data=await res.json();

const route=data.routes[0];

if(window.routeLine) map.removeLayer(window.routeLine);

window.routeLine=L.geoJSON(route.geometry,{style:{weight:6}}).addTo(map);
map.fitBounds(window.routeLine.getBounds());

meta.innerHTML=`Distanz: ${(route.distance/1000).toFixed(1)} km<br>Zeit: ${Math.round(route.duration/60)} min`;
}
</script>

</body>
</html>
