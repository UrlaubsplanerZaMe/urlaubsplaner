<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Urlaubsplaner</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    body { margin: 0; }
    #map { height: 100vh; }

    .panel {
      position: absolute;
      top: 12px;
      left: 12px;
      z-index: 1000;
      width: 320px;
      max-width: calc(100vw - 24px);
      background: rgba(255,255,255,0.95);
      border-radius: 14px;
      padding: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.18);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    .panel h1 {
      font-size: 16px;
      margin: 0 0 10px 0;
    }

    .row { display: flex; gap: 8px; }
    .row > * { flex: 1; }

    label {
      display: block;
      font-size: 12px;
      opacity: 0.8;
      margin: 8px 0 4px;
    }

    input[type="text"]{
      width: 100%;
      box-sizing: border-box;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 10px;
      outline: none;
      font-size: 14px;
    }

    .stopRow {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 8px;
    }
    .stopRow input { flex: 1; }
    .smallBtn {
      border: 0;
      border-radius: 10px;
      padding: 10px 10px;
      cursor: pointer;
      background: #eee;
      font-weight: 600;
    }

    .btn {
      border: 0;
      border-radius: 12px;
      padding: 12px;
      cursor: pointer;
      font-weight: 700;
      font-size: 14px;
    }
    .primary { background: #1f6feb; color: white; }
    .danger { background: #d1242f; color: white; }
    .muted { background: #f1f1f1; color: #111; }

    .hint {
      margin-top: 10px;
      font-size: 13px;
      background: #f6f7f9;
      border-radius: 12px;
      padding: 10px;
      border: 1px solid #e6e8ee;
    }

    .status {
      margin-top: 10px;
      font-size: 13px;
      background: #ffffff;
      border-radius: 12px;
      padding: 10px;
      border: 1px solid #e6e8ee;
      min-height: 20px;
    }

    .pill {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      background: #eef3ff;
      color: #1f6feb;
      margin-left: 6px;
    }
  </style>
</head>
<body>
  <div class="panel">
    <h1>Urlaubsplaner <span class="pill" id="modePill">Auto</span></h1>

    <div class="row">
      <button class="btn muted" onclick="setProfile('driving')">ğŸš— Auto</button>
      <button class="btn muted" onclick="setProfile('cycling')">ğŸš´ Fahrrad</button>
      <button class="btn muted" onclick="setProfile('walking')">ğŸš¶ Zu FuÃŸ</button>
    </div>

    <label>ğŸ“ Start (Adresse)</label>
    <input id="startAddr" type="text" placeholder="z.B. Marienplatz 1, MÃ¼nchen" />

    <label>ğŸŸ¡ Zwischenstopps (Adresse)</label>
    <div id="stops"></div>
    <button class="btn muted" style="width:100%; margin-top:8px;" onclick="addStop()">â• Zwischenstopp hinzufÃ¼gen</button>

    <label>ğŸ Ziel (Adresse)</label>
    <input id="endAddr" type="text" placeholder="z.B. Domplatz 1, KÃ¶ln" />

    <div class="row" style="margin-top:10px;">
      <button class="btn primary" onclick="buildRoute()">ğŸ§­ Route berechnen</button>
      <button class="btn danger" onclick="clearAll()">ğŸ—‘ï¸ Alles lÃ¶schen</button>
    </div>

    <div class="hint">
      Tipp: Gib Start/Ziel/Stops als Adresse ein â†’ <b>Route berechnen</b>.
      <br/>Falls nix gefunden wird: Stadt/Land dazuschreiben.
    </div>

    <div class="status" id="statusBox"></div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // ---------------- Map ----------------
    const map = L.map('map').setView([51.1657, 10.4515], 6); // Deutschland

    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // ---------------- UI state ----------------
    let profile = "driving"; // driving / cycling / walking
    const modePill = document.getElementById("modePill");
    const statusBox = document.getElementById("statusBox");
    const stopsDiv = document.getElementById("stops");

    function setProfile(p){
      profile = p;
      modePill.textContent = p === "driving" ? "Auto" : (p === "cycling" ? "Fahrrad" : "Zu FuÃŸ");
    }

    function setStatus(msg){
      statusBox.textContent = msg;
    }

    // Add first stop field initially (optional - you can delete it)
    addStop(false);

    function addStop(focus=true){
      const row = document.createElement("div");
      row.className = "stopRow";

      const input = document.createElement("input");
      input.type = "text";
      input.placeholder = "z.B. Salzburg, Ã–sterreich";

      const del = document.createElement("button");
      del.className = "smallBtn";
      del.textContent = "âœ–";
      del.title = "Zwischenstopp lÃ¶schen";
      del.onclick = () => row.remove();

      row.appendChild(input);
      row.appendChild(del);
      stopsDiv.appendChild(row);

      if(focus) input.focus();
    }

    // ---------------- Markers + Route Layer ----------------
    let startMarker = null;
    let endMarker = null;
    let stopMarkers = [];
    let routeLine = null;

    function clearMapLayers(){
      if(startMarker){ map.removeLayer(startMarker); startMarker = null; }
      if(endMarker){ map.removeLayer(endMarker); endMarker = null; }
      stopMarkers.forEach(m => map.removeLayer(m));
      stopMarkers = [];
      if(routeLine){ map.removeLayer(routeLine); routeLine = null; }
    }

    function clearAll(){
      document.getElementById("startAddr").value = "";
      document.getElementById("endAddr").value = "";
      stopsDiv.innerHTML = "";
      addStop(false);
      clearMapLayers();
      setStatus("");
    }

    // ---------------- Geocoding (Nominatim) ----------------
    async function geocode(query){
      const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(query)}`;
      // Nominatim mag eigentlich einen eindeutigen User-Agent; im Browser geht das nur eingeschrÃ¤nkt.
      const res = await fetch(url, { headers: { "Accept": "application/json" } });
      if(!res.ok) throw new Error("Geocoding-Fehler");
      const data = await res.json();
      if(!data || !data.length) return null;
      return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon), name: data[0].display_name };
    }

    // ---------------- Routing (OSRM) ----------------
    async function routeOSRM(coords){
      // coords = [{lat, lon}, ...]
      // OSRM expects lon,lat;lon,lat
      const coordStr = coords.map(c => `${c.lon},${c.lat}`).join(";");
      const url = `https://router.project-osrm.org/route/v1/${profile}/${coordStr}?overview=full&geometries=geojson&steps=false`;

      const res = await fetch(url, { headers: { "Accept": "application/json" } });
      if(!res.ok) throw new Error("Routing-Fehler");
      const data = await res.json();
      if(!data.routes || !data.routes.length) return null;
      return data.routes[0];
    }

    function km(m){ return (m/1000).toFixed(1); }
    function hmin(sec){
      const m = Math.round(sec/60);
      const h = Math.floor(m/60);
      const mm = m % 60;
      return h > 0 ? `${h} h ${mm} min` : `${mm} min`;
    }

    // ---------------- Main: build route ----------------
    async function buildRoute(){
      try{
        setStatus("Suche Adressenâ€¦");

        const startText = document.getElementById("startAddr").value.trim();
        const endText = document.getElementById("endAddr").value.trim();

        if(!startText || !endText){
          setStatus("Bitte Start UND Ziel eingeben.");
          return;
        }

        clearMapLayers();

        const start = await geocode(startText);
        if(!start){ setStatus("Start-Adresse nicht gefunden."); return; }

        // stops
        const stopInputs = Array.from(stopsDiv.querySelectorAll("input"))
          .map(i => i.value.trim())
          .filter(v => v.length > 0);

        const stops = [];
        for(const s of stopInputs){
          const g = await geocode(s);
          if(!g){
            setStatus(`Zwischenstopp nicht gefunden: "${s}"`);
            return;
          }
          stops.push(g);
        }

        const end = await geocode(endText);
        if(!end){ setStatus("Ziel-Adresse nicht gefunden."); return; }

        setStatus("Berechne Routeâ€¦");

        const all = [start, ...stops, end];
        const r = await routeOSRM(all);
        if(!r){ setStatus("Keine Route gefunden."); return; }

        // Markers
        startMarker = L.marker([start.lat, start.lon]).addTo(map).bindPopup("Start");
        endMarker = L.marker([end.lat, end.lon]).addTo(map).bindPopup("Ziel");

        stopMarkers = stops.map((s, idx) =>
          L.marker([s.lat, s.lon]).addTo(map).bindPopup(`Zwischenstopp ${idx+1}`)
        );

        // Route line
        routeLine = L.geoJSON(r.geometry, {
          style: { weight: 5 }
        }).addTo(map);

        // Fit map
        const bounds = routeLine.getBounds();
        map.fitBounds(bounds.pad(0.15));

        // Stats
        setStatus(`Route: Distanz ${km(r.distance)} km â€¢ Zeit ${hmin(r.duration)}`);
      } catch(e){
        console.error(e);
        setStatus("Fehler. Bitte nochmal probieren (oder Adresse genauer schreiben).");
      }
    }
  </script>
</body>
</html>
