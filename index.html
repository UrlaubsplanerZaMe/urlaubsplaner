<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <title>Urlaubsplaner</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2A7FFF">

  <!-- iOS App -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Urlaubsplaner">
  <link rel="apple-touch-icon" href="icon-192.png">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0a84ff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Urlaubsplaner">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    :root{
      --bg: rgba(255,255,255,0.92);
      --border: rgba(0,0,0,0.08);
      --shadow: 0 16px 40px rgba(0,0,0,0.18);
      --text: #0b0f14;
      --sub: rgba(11,15,20,0.65);
      --blue: #0a84ff;
      --red: #ff3b30;
      --chip: rgba(10,132,255,0.12);
    }

    body{ margin:0; }
    #map{ height:100vh; width:100vw; }

    .panel{
      position:absolute;
      top:14px; left:14px;
      z-index:1000;
      width:390px;
      max-width: calc(100vw - 28px);
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      font-family: -apple-system, BlinkMacSystemFont, system-ui, Segoe UI, Roboto, Arial, sans-serif;
      overflow:hidden;
    }

    .header{
      padding: 14px 14px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .title{
      font-size: 16px;
      font-weight: 900;
      color: var(--text);
      display:flex;
      align-items:center;
      gap:8px;
    }
    .chip{
      font-size: 12px;
      font-weight: 800;
      padding: 4px 10px;
      border-radius: 999px;
      background: var(--chip);
      color: var(--blue);
      border: 1px solid rgba(10,132,255,0.18);
      white-space: nowrap;
    }

    .tabs{
      display:flex;
      gap:8px;
      padding: 0 14px 10px;
      flex-wrap: wrap;
    }
    .tab{
      flex:1 1 45%;
      padding:10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,0.08);
      background: rgba(0,0,0,0.04);
      font-weight: 900;
      cursor:pointer;
      color: var(--text);
      text-align:center;
      user-select:none;
      font-size: 13px;
    }
    .tab.active{
      background: rgba(10,132,255,0.12);
      border-color: rgba(10,132,255,0.22);
      color: var(--blue);
    }

    .content{ padding: 0 14px 14px; }

    label{
      display:block;
      margin: 10px 0 6px;
      font-size: 12px;
      font-weight: 800;
      color: var(--sub);
    }

    .row{ display:flex; gap:8px; }
    .row > * { flex: 1; }

    .field{
      width:100%;
      box-sizing:border-box;
      border: 1px solid rgba(0,0,0,0.10);
      background: rgba(255,255,255,0.96);
      border-radius: 14px;
      padding: 12px 12px;
      font-size: 14px;
      outline:none;
      color: var(--text);
    }
    .field:focus{
      border-color: rgba(10,132,255,0.45);
      box-shadow: 0 0 0 4px rgba(10,132,255,0.12);
    }

    .btn{
      border:0;
      border-radius: 14px;
      padding: 12px 12px;
      cursor:pointer;
      font-weight: 900;
      font-size: 14px;
      background: rgba(0,0,0,0.06);
      color: var(--text);
    }
    .btn:active{ transform: scale(0.99); }
    .primary{ background: var(--blue); color:#fff; }
    .danger{ background: rgba(255,59,48,0.12); color: var(--red); border: 1px solid rgba(255,59,48,0.22); }
    .small{ padding: 10px 10px; font-size: 13px; }

    .divider{
      height: 1px;
      background: rgba(0,0,0,0.07);
      margin: 12px 0 10px;
    }

    .card{
      background: rgba(255,255,255,0.9);
      border: 1px solid rgba(0,0,0,0.08);
      border-radius: 14px;
      padding: 10px;
    }

    .list{
      max-height: 220px;
      overflow:auto;
      background: rgba(0,0,0,0.03);
      border-radius: 14px;
      padding: 8px;
      border: 1px solid rgba(0,0,0,0.06);
    }
    .item{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:space-between;
      padding:10px;
      background: rgba(255,255,255,0.9);
      border: 1px solid rgba(0,0,0,0.07);
      border-radius: 14px;
      margin-bottom: 8px;
    }
    .item:last-child{ margin-bottom:0; }
    .itemLeft{ min-width:0; }
    .itemTitle{ font-weight: 900; font-size: 14px; color: var(--text); }
    .itemSub{ font-size: 12px; color: var(--sub); margin-top: 2px; }
    .itemBtns{ display:flex; gap:6px; }
    .pillBtn{
      padding: 9px 10px;
      border-radius: 12px;
      border:0;
      font-weight: 900;
      cursor:pointer;
    }
    .pillLoad{ background: var(--blue); color:#fff; }
    .pillDel{ background: rgba(255,59,48,0.12); color: var(--red); border: 1px solid rgba(255,59,48,0.22); }

    .twoCol{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:8px;
    }

    .meta{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      font-size: 13px;
      color: var(--sub);
      line-height: 1.4;
      background: rgba(255,255,255,0.9);
      border: 1px solid rgba(0,0,0,0.08);
      border-radius: 14px;
      padding: 10px;
      margin-top: 10px;
    }
    .meta strong{ color: var(--text); }

    /* Profilbild */
    .avatarWrap{ display:flex; gap:10px; align-items:center; }
    .avatar{
      width:64px; height:64px;
      border-radius: 18px;
      border: 1px solid rgba(0,0,0,0.10);
      object-fit: cover;
      background: rgba(0,0,0,0.04);
    }

    /* Leaflet Zoom + / - unten rechts, iOS-like */
    .leaflet-control-zoom{
      border: 1px solid rgba(0,0,0,0.12) !important;
      border-radius: 14px !important;
      overflow:hidden !important;
      box-shadow: 0 16px 40px rgba(0,0,0,0.18) !important;
    }
    .leaflet-control-zoom a{
      width: 44px !important;
      height: 44px !important;
      line-height: 44px !important;
      font-size: 18px !important;
    }
  </style>
</head>

<body>
  <div class="panel">
    <div class="header">
      <div class="title">Urlaubsplaner <span class="chip">ðŸš— Auto</span></div>
      <button class="btn small" onclick="newTrip()">Neu</button>
    </div>

    <div class="tabs">
      <div class="tab active" id="tabTrip" onclick="switchTab('trip')">Reise</div>
      <div class="tab" id="tabDays" onclick="switchTab('days')">Tage</div>
      <div class="tab" id="tabPlan" onclick="switchTab('plan')">Tagesplan</div>
      <div class="tab" id="tabCats" onclick="switchTab('cats')">Rubriken</div>
      <div class="tab" id="tabProfile" onclick="switchTab('profile')">Profil</div>
    </div>

    <div class="content">
      <!-- ===== Reise ===== -->
      <div id="viewTrip">
        <label>Reise-Name</label>
        <input id="tripName" class="field" placeholder="z.B. Gardasee 2026" />

        <div class="row" style="margin-top:8px;">
          <input id="dateFrom" class="field" type="date" />
          <input id="dateTo" class="field" type="date" />
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="btn primary" onclick="generateDays()">Tage erzeugen</button>
          <button class="btn" onclick="saveTrip()">Reise speichern</button>
        </div>

        <div class="divider"></div>

        <label>Gespeicherte Reisen</label>
        <div class="list" id="tripList"></div>
      </div>

      <!-- ===== Tage ===== -->
      <div id="viewDays" style="display:none;">
        <div class="card">
          <div class="itemTitle" id="currentTripLabel">Keine Reise geladen</div>
          <div class="itemSub" id="currentTripRange">â€”</div>
        </div>

        <label style="margin-top:10px;">Tage</label>
        <div class="list" id="dayList"></div>
      </div>

      <!-- ===== Tagesplan ===== -->
      <div id="viewPlan" style="display:none;">
        <div class="card">
          <div class="itemTitle" id="planHeader">Kein Tag gewÃ¤hlt</div>
          <div class="itemSub" id="planSub">â€”</div>
        </div>

        <label style="margin-top:10px;">Routen am Tag</label>
        <div class="row">
          <input id="newRouteName" class="field" placeholder='z.B. "Anreise", "Mittagstour"'/>
          <button class="btn primary" onclick="addRoute()">+ Route</button>
        </div>

        <div class="list" id="routeList" style="max-height: 160px;"></div>

        <div class="divider"></div>

        <label>Stops in der ausgewÃ¤hlten Route</label>
        <div class="twoCol">
          <button class="btn small" onclick="setPickModeStop()">Stop per Karte</button>
          <button class="btn small" onclick="clearPickMode()">Stop-Modus aus</button>
        </div>

        <div class="row" style="margin-top:8px;">
          <input id="stopAddr" class="field" placeholder="Adresse suchen (optional)" />
          <button class="btn small" onclick="addStopByAddress()">+ Stop</button>
        </div>

        <div class="list" id="stopList" style="max-height: 200px;"></div>

        <div class="meta" id="routeMeta">
          <span><strong>Route:</strong> â€”</span>
          <span><strong>Distanz:</strong> â€”</span>
          <span><strong>Zeit:</strong> â€”</span>
        </div>

        <div class="divider"></div>

        <label>Stop-Details</label>
        <div class="card" id="stopDetails">
          <div style="color: rgba(0,0,0,0.55); font-size: 13px;">WÃ¤hle einen Stop aus.</div>
        </div>
      </div>

      <!-- ===== Rubriken ===== -->
      <div id="viewCats" style="display:none;">
        <label>Neue Rubrik hinzufÃ¼gen</label>
        <div class="row">
          <input id="newCatName" class="field" placeholder="z.B. Fotospot, Kinder, Badestelle" />
          <button class="btn primary" onclick="addCategory()">+ Rubrik</button>
        </div>

        <label style="margin-top:10px;">Rubriken</label>
        <div class="list" id="catList"></div>
      </div>

      <!-- ===== Profil ===== -->
      <div id="viewProfile" style="display:none;">
        <div class="card">
          <div class="avatarWrap">
            <img id="profileAvatar" class="avatar" alt="Profilbild" />
            <div style="flex:1;">
              <div class="itemTitle" id="profileTitle">Kein Profil</div>
              <div class="itemSub" id="profileSub">Erstelle dein Profil fÃ¼r spÃ¤ter.</div>
            </div>
          </div>
        </div>

        <label style="margin-top:10px;">Name / Nickname</label>
        <input id="profileName" class="field" placeholder="z.B. Max, Familie MÃ¼ller, RoadtripCrew" />

        <label>Reiseart</label>
        <select id="travelType" class="field">
          <option value="alleine">Alleine</option>
          <option value="freunde">Mit Freunden</option>
          <option value="familie">Mit Familie</option>
        </select>

        <label>Profilbild</label>
        <input id="profileImg" class="field" type="file" accept="image/*" />

        <label>Kurztext (optional)</label>
        <textarea id="profileBio" class="field" rows="4" style="resize:vertical;" placeholder="z.B. Wir lieben Camping und Natur..."></textarea>

        <div class="row" style="margin-top:10px;">
          <button class="btn primary" onclick="saveProfile()">Profil speichern</button>
          <button class="btn danger" onclick="deleteProfile()">Profil lÃ¶schen</button>
        </div>
      </div>

    </div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // =========================
    // Storage
    // =========================
    const STORAGE_KEY = "urlaubsplaner_state_v2";
    function loadState(){
      try {
        const s = JSON.parse(localStorage.getItem(STORAGE_KEY));
        if(!s || typeof s !== "object") return { trips: [], profile: null };
        if(!Array.isArray(s.trips)) s.trips = [];
        if(!("profile" in s)) s.profile = null;
        return s;
      } catch(e){
        return { trips: [], profile: null };
      }
    }
    function saveState(state){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

    // =========================
    // Map setup (Zoom unten rechts)
    // =========================
    const map = L.map('map', { zoomControl: false }).setView([49.8, 9.0], 7);
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    const stopLayer = L.layerGroup().addTo(map);
    let routeLine = null;

    // =========================
    // App state
    // =========================
    const app = {
      data: loadState(),
      currentTripId: null,
      currentDayId: null,
      currentRouteId: null,
      currentStopId: null,
      pickModeStop: false,
      markersByStopId: new Map()
    };

    // =========================
    // Helpers
    // =========================
    function uid(){ return Math.random().toString(36).slice(2,10) + "_" + Date.now().toString(36); }
    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    function defaultCategories(){
      return [
        { id: uid(), name: "Essen" },
        { id: uid(), name: "SehenswÃ¼rdigkeit" },
        { id: uid(), name: "Tankstelle" },
        { id: uid(), name: "Parken" },
        { id: uid(), name: "Einkauf" },
        { id: uid(), name: "Pause" }
      ];
    }

    function currentTrip(){ return app.data.trips.find(t => t.id === app.currentTripId) || null; }
    function currentDay(){
      const t = currentTrip();
      return t?.days?.find(d => d.id === app.currentDayId) || null;
    }
    function currentRoute(){
      const d = currentDay();
      return d?.routes?.find(r => r.id === app.currentRouteId) || null;
    }
    function currentStop(){
      const r = currentRoute();
      return r?.stops?.find(s => s.id === app.currentStopId) || null;
    }
    function catName(catId){
      const t = currentTrip();
      return t?.categories?.find(c => c.id === catId)?.name || "Ohne";
    }

    // =========================
    // UI refs
    // =========================
    const tabs = {
      trip: document.getElementById("tabTrip"),
      days: document.getElementById("tabDays"),
      plan: document.getElementById("tabPlan"),
      cats: document.getElementById("tabCats"),
      profile: document.getElementById("tabProfile")
    };
    const views = {
      trip: document.getElementById("viewTrip"),
      days: document.getElementById("viewDays"),
      plan: document.getElementById("viewPlan"),
      cats: document.getElementById("viewCats"),
      profile: document.getElementById("viewProfile")
    };

    const tripNameEl = document.getElementById("tripName");
    const dateFromEl = document.getElementById("dateFrom");
    const dateToEl = document.getElementById("dateTo");
    const tripListEl = document.getElementById("tripList");

    const currentTripLabel = document.getElementById("currentTripLabel");
    const currentTripRange = document.getElementById("currentTripRange");
    const dayListEl = document.getElementById("dayList");

    const planHeader = document.getElementById("planHeader");
    const planSub = document.getElementById("planSub");
    const newRouteNameEl = document.getElementById("newRouteName");
    const routeListEl = document.getElementById("routeList");
    const stopListEl = document.getElementById("stopList");
    const stopAddrEl = document.getElementById("stopAddr");
    const routeMetaEl = document.getElementById("routeMeta");
    const stopDetailsEl = document.getElementById("stopDetails");

    const newCatNameEl = document.getElementById("newCatName");
    const catListEl = document.getElementById("catList");

    // Profile
    const profileAvatarEl = document.getElementById("profileAvatar");
    const profileTitleEl = document.getElementById("profileTitle");
    const profileSubEl = document.getElementById("profileSub");
    const profileNameEl = document.getElementById("profileName");
    const travelTypeEl = document.getElementById("travelType");
    const profileImgEl = document.getElementById("profileImg");
    const profileBioEl = document.getElementById("profileBio");

    // =========================
    // Tabs
    // =========================
    function switchTab(name){
      Object.values(tabs).forEach(t => t.classList.remove("active"));
      Object.values(views).forEach(v => v.style.display = "none");
      tabs[name].classList.add("active");
      views[name].style.display = "block";
      if(name === "profile") renderProfile();
    }
    window.switchTab = switchTab;

    // =========================
    // Trip CRUD
    // =========================
    function newTrip(){
      app.currentTripId = null;
      app.currentDayId = null;
      app.currentRouteId = null;
      app.currentStopId = null;
      tripNameEl.value = "";
      dateFromEl.value = "";
      dateToEl.value = "";
      clearStopsAndRoute();
      renderAll();
      switchTab("trip");
    }
    window.newTrip = newTrip;

    function saveTrip(){
      const name = (tripNameEl.value || "").trim();
      const dateFrom = dateFromEl.value || "";
      const dateTo = dateToEl.value || "";
      if(!name){ alert("Bitte Reise-Name eingeben."); return; }
      if(!dateFrom || !dateTo){ alert("Bitte Datum von/bis auswÃ¤hlen."); return; }

      let t = currentTrip();
      if(!t){
        t = { id: uid(), name, dateFrom, dateTo, categories: defaultCategories(), days: [] };
        app.data.trips.unshift(t);
        app.currentTripId = t.id;
      } else {
        t.name = name; t.dateFrom = dateFrom; t.dateTo = dateTo;
        if(!Array.isArray(t.categories) || t.categories.length === 0) t.categories = defaultCategories();
        if(!Array.isArray(t.days)) t.days = [];
      }
      saveState(app.data);
      renderAll();
      alert("Reise gespeichert.");
    }
    window.saveTrip = saveTrip;

    function deleteTrip(id){
      app.data.trips = app.data.trips.filter(t => t.id !== id);
      if(app.currentTripId === id) newTrip();
      saveState(app.data);
      renderAll();
    }

    function loadTrip(id){
      const t = app.data.trips.find(x => x.id === id);
      if(!t) return;

      app.currentTripId = t.id;
      app.currentDayId = t.days?.[0]?.id || null;
      app.currentRouteId = t.days?.[0]?.routes?.[0]?.id || null;
      app.currentStopId = null;

      tripNameEl.value = t.name || "";
      dateFromEl.value = t.dateFrom || "";
      dateToEl.value = t.dateTo || "";

      clearStopsAndRoute();
      renderAll();
      switchTab("days");
    }

    // =========================
    // Days
    // =========================
    function dateToISO(d){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${dd}`;
    }

    function generateDays(){
      const name = (tripNameEl.value || "").trim();
      if(!name){ alert("Bitte erst Reise-Name eingeben."); return; }
      saveTrip();

      const t = currentTrip();
      const from = new Date(t.dateFrom + "T00:00:00");
      const to = new Date(t.dateTo + "T00:00:00");
      if(isNaN(from.getTime()) || isNaN(to.getTime()) || from > to){
        alert("Datum stimmt nicht. Bitte prÃ¼fen.");
        return;
      }

      const existingByDate = new Map((t.days||[]).map(d => [d.date, d]));
      const days = [];
      let cur = new Date(from);
      let idx = 1;
      while(cur <= to){
        const iso = dateToISO(cur);
        const ex = existingByDate.get(iso);
        if(ex){
          ex.dayIndex = idx;
          if(!Array.isArray(ex.routes)) ex.routes = [];
          days.push(ex);
        }else{
          days.push({ id: uid(), date: iso, dayIndex: idx, routes: [] });
        }
        cur.setDate(cur.getDate()+1);
        idx++;
      }

      t.days = days;
      app.currentDayId = t.days[0]?.id || null;
      app.currentRouteId = t.days[0]?.routes?.[0]?.id || null;
      app.currentStopId = null;

      saveState(app.data);
      renderAll();
      switchTab("days");
    }
    window.generateDays = generateDays;

    function selectDay(dayId){
      app.currentDayId = dayId;
      const d = currentDay();
      app.currentRouteId = d?.routes?.[0]?.id || null;
      app.currentStopId = null;
      clearStopsAndRoute();
      renderAll();
      switchTab("plan");
      drawSelectedRoute();
    }

    // =========================
    // Routes / Stops
    // =========================
    function addRoute(){
      const t = currentTrip();
      const d = currentDay();
      if(!t || !d){ alert("Bitte zuerst Reise laden und Tag wÃ¤hlen."); return; }
      const nm = (newRouteNameEl.value || "").trim() || "Route";
      const r = { id: uid(), name: nm, stops: [] };
      d.routes.unshift(r);
      newRouteNameEl.value = "";
      app.currentRouteId = r.id;
      app.currentStopId = null;

      saveState(app.data);
      renderAll();
      clearStopsAndRoute();
      drawSelectedRoute();
    }
    window.addRoute = addRoute;

    function selectRoute(routeId){
      app.currentRouteId = routeId;
      app.currentStopId = null;
      saveState(app.data);
      renderAll();
      clearStopsAndRoute();
      drawSelectedRoute();
    }

    function deleteRoute(routeId){
      const d = currentDay();
      if(!d) return;
      d.routes = d.routes.filter(r => r.id !== routeId);
      if(app.currentRouteId === routeId){
        app.currentRouteId = d.routes?.[0]?.id || null;
        app.currentStopId = null;
      }
      saveState(app.data);
      renderAll();
      clearStopsAndRoute();
      drawSelectedRoute();
    }

    function setPickModeStop(){
      if(!currentRoute()){ alert("Bitte zuerst eine Route auswÃ¤hlen/erstellen."); return; }
      app.pickModeStop = true;
      alert("Stop-Modus aktiv: Tippe auf die Karte, um einen Stop hinzuzufÃ¼gen.");
    }
    window.setPickModeStop = setPickModeStop;

    function clearPickMode(){ app.pickModeStop = false; }
    window.clearPickMode = clearPickMode;

    function makeStop({name, lat, lon}){
      const t = currentTrip();
      const catId = t?.categories?.[0]?.id || null;
      return { id: uid(), name: name || "Stop", categoryId: catId, note: "", lat, lon, images: [] };
    }

    async function addStopByAddress(){
      const r = currentRoute();
      if(!r){ alert("Bitte zuerst eine Route auswÃ¤hlen."); return; }
      const q = (stopAddrEl.value || "").trim();
      if(!q){ alert("Bitte Adresse eingeben."); return; }

      const g = await geocodeOne(q);
      if(!g){ alert("Adresse nicht gefunden."); return; }

      const s = makeStop({ name: q, lat: g.lat, lon: g.lon });
      r.stops.push(s);
      stopAddrEl.value = "";
      app.currentStopId = s.id;

      saveState(app.data);
      renderAll();
      drawSelectedRoute();
      focusStop(s.id);
    }
    window.addStopByAddress = addStopByAddress;

    function selectStop(stopId){
      app.currentStopId = stopId;
      renderStopDetails();
      focusStop(stopId);
    }

    function deleteStop(stopId){
      const r = currentRoute();
      if(!r) return;
      r.stops = r.stops.filter(s => s.id !== stopId);
      if(app.currentStopId === stopId) app.currentStopId = null;

      saveState(app.data);
      renderAll();
      clearStopsAndRoute();
      drawSelectedRoute();
    }

    // Karte: Stops hinzufÃ¼gen
    map.on("click", (e) => {
      if(!app.pickModeStop) return;
      const r = currentRoute();
      if(!r) return;

      const s = makeStop({ name: "Neuer Stop", lat: e.latlng.lat, lon: e.latlng.lng });
      r.stops.push(s);
      app.currentStopId = s.id;

      saveState(app.data);
      renderAll();
      drawSelectedRoute();
      focusStop(s.id);
    });

    function clearStopsAndRoute(){
      if(routeLine){ map.removeLayer(routeLine); routeLine = null; }
      stopLayer.clearLayers();
      app.markersByStopId.clear();
    }

    function focusStop(stopId){
      const m = app.markersByStopId.get(stopId);
      if(m){
        map.setView(m.getLatLng(), Math.max(map.getZoom(), 12));
        m.openPopup();
      }
    }

    // =========================
    // Routing + draw
    // =========================
    async function drawSelectedRoute(){
      const r = currentRoute();
      if(!r){
        setRouteMeta("â€”","â€”","â€”");
        clearStopsAndRoute();
        return;
      }

      clearStopsAndRoute();

      (r.stops||[]).forEach((s, idx) => {
        const tag = catName(s.categoryId);
        const m = L.marker([s.lat, s.lon], { draggable:true }).addTo(stopLayer);
        app.markersByStopId.set(s.id, m);

        m.bindPopup(`<b>${escapeHtml(s.name || ("Stop " + (idx+1)))}</b><br><span style="opacity:.7">${escapeHtml(tag)}</span>`);
        m.on("click", () => selectStop(s.id));
        m.on("dragend", () => {
          const p = m.getLatLng();
          s.lat = p.lat; s.lon = p.lng;
          saveState(app.data);
          renderAll();
          drawSelectedRoute();
        });
      });

      if((r.stops||[]).length < 2){
        setRouteMeta(r.name, "â€”", "â€”");
        return;
      }

      const pts = r.stops.map(s => ({ lat: s.lat, lon: s.lon }));
      const route = await routeOSRM(pts);
      if(!route){
        setRouteMeta(r.name, "â€”", "â€”");
        return;
      }

      routeLine = L.geoJSON(route.geometry, { style: { weight: 6, opacity: 0.95 } }).addTo(map);
      map.fitBounds(routeLine.getBounds().pad(0.15));

      const km = (route.distance/1000).toFixed(1) + " km";
      const min = Math.round(route.duration/60) + " min";
      setRouteMeta(r.name, km, min);
    }

    function setRouteMeta(name, dist, time){
      routeMetaEl.innerHTML = `
        <span><strong>Route:</strong> ${escapeHtml(name || "â€”")}</span>
        <span><strong>Distanz:</strong> ${escapeHtml(dist || "â€”")}</span>
        <span><strong>Zeit:</strong> ${escapeHtml(time || "â€”")}</span>
      `;
    }

    async function routeOSRM(points){
      const coordStr = points.map(p => `${p.lon},${p.lat}`).join(";");
      const url = `https://router.project-osrm.org/route/v1/driving/${coordStr}?overview=full&geometries=geojson&steps=false`;
      const res = await fetch(url, { headers: { "Accept":"application/json" }});
      const data = await res.json();
      return data.routes && data.routes[0] ? data.routes[0] : null;
    }

    async function geocodeOne(q){
      const m = q.match(/^\s*(-?\d+(\.\d+)?)\s*,\s*(-?\d+(\.\d+)?)\s*$/);
      if(m) return { lat: parseFloat(m[1]), lon: parseFloat(m[3]) };

      const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(q)}`;
      const res = await fetch(url, { headers: { "Accept":"application/json" }});
      const data = await res.json();
      if(!data || !data[0]) return null;
      return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
    }

    // =========================
    // Stop Details (Text + Bilder)
    // =========================
    function renderStopDetails(){
      const s = currentStop();
      const t = currentTrip();
      if(!s || !t){
        stopDetailsEl.innerHTML = `<div style="color: rgba(0,0,0,0.55); font-size: 13px;">WÃ¤hle einen Stop aus.</div>`;
        return;
      }

      const catOptions = (t.categories||[]).map(c => {
        const sel = c.id === s.categoryId ? "selected" : "";
        return `<option value="${c.id}" ${sel}>${escapeHtml(c.name)}</option>`;
      }).join("");

      const imgs = (s.images||[]).map(src =>
        `<img src="${src}" alt="Bild" style="width:100%;height:80px;object-fit:cover;border-radius:12px;border:1px solid rgba(0,0,0,0.08);">`
      ).join("");

      stopDetailsEl.innerHTML = `
        <label style="margin-top:0;">Name</label>
        <input class="field" id="sdName" value="${escapeHtml(s.name||"")}" />

        <label>Rubrik</label>
        <select class="field" id="sdCat">${catOptions}</select>

        <label>Text / Notiz</label>
        <textarea class="field" id="sdNote" rows="4" style="resize:vertical;">${escapeHtml(s.note||"")}</textarea>

        <div class="row" style="margin-top:10px;">
          <button class="btn primary" id="sdSave">Speichern</button>
          <button class="btn danger" id="sdDelete">Stop lÃ¶schen</button>
        </div>

        <div class="divider"></div>

        <label>Bilder (lokal)</label>
        <input class="field" id="sdImg" type="file" accept="image/*" />
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px;">${imgs}</div>
      `;

      document.getElementById("sdSave").onclick = () => {
        s.name = document.getElementById("sdName").value.trim() || "Stop";
        s.categoryId = document.getElementById("sdCat").value;
        s.note = document.getElementById("sdNote").value || "";
        saveState(app.data);
        renderAll();
        drawSelectedRoute();
        focusStop(s.id);
      };

      document.getElementById("sdDelete").onclick = () => {
        if(confirm("Stop wirklich lÃ¶schen?")) deleteStop(s.id);
      };

      document.getElementById("sdImg").onchange = async (ev) => {
        const file = ev.target.files?.[0];
        if(!file) return;
        const base64 = await fileToBase64(file);
        if(!Array.isArray(s.images)) s.images = [];
        s.images.unshift(base64);
        saveState(app.data);
        renderStopDetails();
      };
    }

    function fileToBase64(file){
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // =========================
    // Categories
    // =========================
    function addCategory(){
      const t = currentTrip();
      if(!t){ alert("Bitte zuerst eine Reise laden."); return; }
      const nm = (newCatNameEl.value || "").trim();
      if(!nm){ alert("Bitte Rubrik-Name eingeben."); return; }
      t.categories.push({ id: uid(), name: nm });
      newCatNameEl.value = "";
      saveState(app.data);
      renderAll();
    }
    window.addCategory = addCategory;

    function deleteCategory(catId){
      const t = currentTrip();
      if(!t) return;
      const used = (t.days||[]).some(d => (d.routes||[]).some(r => (r.stops||[]).some(s => s.categoryId === catId)));
      if(used){ alert("Diese Rubrik wird noch verwendet. Erst Stops Ã¤ndern, dann lÃ¶schen."); return; }
      t.categories = t.categories.filter(c => c.id !== catId);
      saveState(app.data);
      renderAll();
    }

    // =========================
    // Profile
    // =========================
    function humanTravelType(v){
      if(v === "alleine") return "Reiseart: Alleine";
      if(v === "freunde") return "Reiseart: Mit Freunden";
      if(v === "familie") return "Reiseart: Mit Familie";
      return "Reiseart: â€”";
    }

    function renderProfile(){
      const p = app.data.profile;
      if(p?.avatar) profileAvatarEl.src = p.avatar;
      else profileAvatarEl.removeAttribute("src");

      profileNameEl.value = p?.name || "";
      travelTypeEl.value = p?.travelType || "alleine";
      profileBioEl.value = p?.bio || "";

      profileTitleEl.textContent = p?.name ? p.name : "Kein Profil";
      profileSubEl.textContent = p?.travelType ? humanTravelType(p.travelType) : "Erstelle dein Profil fÃ¼r spÃ¤ter.";
    }

    async function saveProfile(){
      const name = (profileNameEl.value || "").trim();
      const travelType = travelTypeEl.value;
      const bio = profileBioEl.value || "";

      let avatar = app.data.profile?.avatar || null;
      const file = profileImgEl.files?.[0];
      if(file) avatar = await fileToBase64(file);

      app.data.profile = { name, travelType, bio, avatar, updatedAt: Date.now() };
      saveState(app.data);
      profileImgEl.value = "";
      renderProfile();
      alert("Profil gespeichert.");
    }
    window.saveProfile = saveProfile;

    function deleteProfile(){
      if(!confirm("Profil wirklich lÃ¶schen?")) return;
      app.data.profile = null;
      saveState(app.data);
      renderProfile();
    }
    window.deleteProfile = deleteProfile;

    // =========================
    // Render
    // =========================
    function renderTrips(){
      tripListEl.innerHTML = "";
      if(!app.data.trips.length){
        tripListEl.innerHTML = `<div style="padding:8px; color:rgba(0,0,0,0.55); font-size:13px;">Noch keine Reisen gespeichert.</div>`;
        return;
      }
      for(const t of app.data.trips){
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div class="itemLeft">
            <div class="itemTitle">${escapeHtml(t.name || "")}</div>
            <div class="itemSub">${escapeHtml(t.dateFrom || "â€”")} â€“ ${escapeHtml(t.dateTo || "â€”")}</div>
          </div>
          <div class="itemBtns">
            <button class="pillBtn pillLoad">Laden</button>
            <button class="pillBtn pillDel">LÃ¶schen</button>
          </div>
        `;
        el.querySelector(".pillLoad").onclick = () => loadTrip(t.id);
        el.querySelector(".pillDel").onclick = () => { if(confirm("Reise wirklich lÃ¶schen?")) deleteTrip(t.id); };
        tripListEl.appendChild(el);
      }
    }

    function renderDays(){
      const t = currentTrip();
      currentTripLabel.textContent = t ? t.name : "Keine Reise geladen";
      currentTripRange.textContent = t ? `${t.dateFrom || "â€”"} â€“ ${t.dateTo || "â€”"}` : "â€”";

      dayListEl.innerHTML = "";
      if(!t || !t.days || t.days.length === 0){
        dayListEl.innerHTML = `<div style="padding:8px; color:rgba(0,0,0,0.55); font-size:13px;">Keine Tage vorhanden. Gehe zu â€žReiseâ€œ â†’ â€žTage erzeugenâ€œ.</div>`;
        return;
      }
      for(const d of t.days){
        const el = document.createElement("div");
        el.className = "item";
        const active = (d.id === app.currentDayId);
        el.style.borderColor = active ? "rgba(10,132,255,0.35)" : "rgba(0,0,0,0.07)";
        el.style.background = active ? "rgba(10,132,255,0.08)" : "rgba(255,255,255,0.9)";
        el.innerHTML = `
          <div class="itemLeft">
            <div class="itemTitle">Tag ${d.dayIndex}: ${escapeHtml(d.date)}</div>
            <div class="itemSub">${(d.routes||[]).length} Route(n)</div>
          </div>
          <div class="itemBtns">
            <button class="pillBtn pillLoad">WÃ¤hlen</button>
          </div>
        `;
        el.querySelector(".pillLoad").onclick = () => selectDay(d.id);
        dayListEl.appendChild(el);
      }
    }

    function renderPlan(){
      const t = currentTrip();
      const d = currentDay();
      if(!t || !d){
        planHeader.textContent = "Kein Tag gewÃ¤hlt";
        planSub.textContent = "â€”";
        routeListEl.innerHTML = "";
        stopListEl.innerHTML = "";
        stopDetailsEl.innerHTML = `<div style="color: rgba(0,0,0,0.55); font-size: 13px;">WÃ¤hle einen Stop aus.</div>`;
        setRouteMeta("â€”","â€”","â€”");
        return;
      }

      planHeader.textContent = `${t.name} â€“ Tag ${d.dayIndex}`;
      planSub.textContent = d.date;

      // Routes list
      routeListEl.innerHTML = "";
      if(!d.routes || d.routes.length === 0){
        routeListEl.innerHTML = `<div style="padding:8px; color:rgba(0,0,0,0.55); font-size:13px;">Noch keine Route. Oben â€ž+ Routeâ€œ.</div>`;
      } else {
        for(const r of d.routes){
          const active = (r.id === app.currentRouteId);
          const el = document.createElement("div");
          el.className = "item";
          el.style.borderColor = active ? "rgba(10,132,255,0.35)" : "rgba(0,0,0,0.07)";
          el.style.background = active ? "rgba(10,132,255,0.08)" : "rgba(255,255,255,0.9)";
          el.innerHTML = `
            <div class="itemLeft">
              <div class="itemTitle">${escapeHtml(r.name || "Route")}</div>
              <div class="itemSub">${(r.stops||[]).length} Stop(s)</div>
            </div>
            <div class="itemBtns">
              <button class="pillBtn pillLoad">Ã–ffnen</button>
              <button class="pillBtn pillDel">X</button>
            </div>
          `;
          el.querySelector(".pillLoad").onclick = () => selectRoute(r.id);
          el.querySelector(".pillDel").onclick = () => { if(confirm("Route lÃ¶schen?")) deleteRoute(r.id); };
          routeListEl.appendChild(el);
        }
      }

      // Stops list
      const r = currentRoute();
      stopListEl.innerHTML = "";
      if(!r){
        stopListEl.innerHTML = `<div style="padding:8px; color:rgba(0,0,0,0.55); font-size:13px;">Bitte Route auswÃ¤hlen.</div>`;
        setRouteMeta("â€”","â€”","â€”");
        stopDetailsEl.innerHTML = `<div style="color: rgba(0,0,0,0.55); font-size: 13px;">WÃ¤hle einen Stop aus.</div>`;
        return;
      }

      if(!r.stops || r.stops.length === 0){
        stopListEl.innerHTML = `<div style="padding:8px; color:rgba(0,0,0,0.55); font-size:13px;">Noch keine Stops. Nutze â€žStop per Karteâ€œ oder Adresse.</div>`;
        setRouteMeta(r.name, "â€”", "â€”");
      } else {
        for(const s of r.stops){
          const active = (s.id === app.currentStopId);
          const el = document.createElement("div");
          el.className = "item";
          el.style.borderColor = active ? "rgba(10,132,255,0.35)" : "rgba(0,0,0,0.07)";
          el.style.background = active ? "rgba(10,132,255,0.08)" : "rgba(255,255,255,0.9)";
          el.innerHTML = `
            <div class="itemLeft" style="min-width:0;">
              <div class="itemTitle">${escapeHtml(s.name || "Stop")}</div>
              <div class="itemSub">${escapeHtml(catName(s.categoryId))}${(s.note||"").trim() ? " â€¢ Notiz" : ""}${(s.images||[]).length ? " â€¢ Bilder" : ""}</div>
            </div>
            <div class="itemBtns">
              <button class="pillBtn pillLoad">Edit</button>
              <button class="pillBtn pillDel">X</button>
            </div>
          `;
          el.querySelector(".pillLoad").onclick = () => selectStop(s.id);
          el.querySelector(".pillDel").onclick = () => { if(confirm("Stop lÃ¶schen?")) deleteStop(s.id); };
          stopListEl.appendChild(el);
        }
      }

      renderStopDetails();
    }

    function renderCats(){
      const t = currentTrip();
      catListEl.innerHTML = "";
      if(!t){
        catListEl.innerHTML = `<div style="padding:8px; color:rgba(0,0,0,0.55); font-size:13px;">Bitte zuerst eine Reise laden.</div>`;
        return;
      }
      for(const c of t.categories || []){
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div class="itemLeft">
            <div class="itemTitle">${escapeHtml(c.name)}</div>
            <div class="itemSub">Rubrik</div>
          </div>
          <div class="itemBtns">
            <button class="pillBtn pillDel">LÃ¶schen</button>
          </div>
        `;
        el.querySelector(".pillDel").onclick = () => deleteCategory(c.id);
        catListEl.appendChild(el);
      }
    }

    function renderAll(){
      renderTrips();
      renderDays();
      renderPlan();
      renderCats();
      renderProfile();
    }

    // =========================
    // Init
    // =========================
    renderAll();

    // =========================
    // PWA Service Worker
    // =========================
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("./sw.js");
    }
  </script>
</body>
</html>
