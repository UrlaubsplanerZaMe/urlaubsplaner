<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Urlaubsplaner</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
body{margin:0;}
#map{height:100vh;}
.card{
position:absolute;top:14px;left:14px;z-index:1000;
width:330px;background:#fff;border-radius:18px;
padding:14px;box-shadow:0 16px 40px rgba(0,0,0,0.2);
font-family:-apple-system;
}
.field{width:100%;padding:12px;border-radius:12px;border:1px solid #ddd;margin-bottom:8px;}
.btn{padding:10px;border-radius:12px;border:0;font-weight:700;background:#eee;width:100%;}
.row{display:flex;gap:6px;margin-bottom:8px;}
.meta{font-size:13px;margin-top:8px;}
</style>
</head>
<body>

<div class="card">

<div class="row">
<button class="btn" onclick="mode='start'">Start</button>
<button class="btn" onclick="mode='stop'">Stopp</button>
<button class="btn" onclick="mode='ziel'">Ziel</button>
</div>

<input id="startAddr" class="field" placeholder="Startadresse">
<div id="stops"></div>
<button class="btn" onclick="addStop()">+ Stopp</button>
<input id="endAddr" class="field" placeholder="Zieladresse">

<div class="meta" id="meta"></div>

</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const map=L.map('map').setView([51.1657,10.4515],6);
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

let mode=null;
let startMarker,endMarker;
let stopMarkers=[];

function createMarker(latlng,label,updateField){
const m=L.marker(latlng,{draggable:true}).addTo(map).bindPopup(label);

m.on("dragend", async ()=>{
const p=m.getLatLng();
const addr=await reverseGeocode(p);
updateField(addr);
buildRoute();
});

return m;
}

map.on("click",async e=>{
if(!mode)return;

const addr=await reverseGeocode(e.latlng);

if(mode==="start"){
startAddr.value=addr;
if(startMarker)map.removeLayer(startMarker);
startMarker=createMarker(e.latlng,"Start",a=>startAddr.value=a);
}

if(mode==="ziel"){
endAddr.value=addr;
if(endMarker)map.removeLayer(endMarker);
endMarker=createMarker(e.latlng,"Ziel",a=>endAddr.value=a);
}

if(mode==="stop"){
addStop(addr,e.latlng);
}

buildRoute();
mode=null;
});

function addStop(prefill="",latlng=null){

const input=document.createElement("input");
input.className="field";
input.value=prefill;
stops.appendChild(input);

let marker=null;

if(latlng){
marker=createMarker(latlng,"Stopp",a=>input.value=a);
stopMarkers.push(marker);
}

input.onchange=buildRoute;
}

async function reverseGeocode(p){
const res=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${p.lat}&lon=${p.lng}`);
const data=await res.json();
return data.display_name || `${p.lat},${p.lng}`;
}

async function route(coords){

const c=coords.map(c=>`${c.lng},${c.lat}`).join(";");

const res=await fetch(`https://router.project-osrm.org/route/v1/driving/${c}?overview=full&geometries=geojson`);
const data=await res.json();

return data.routes[0];
}

async function buildRoute(){

if(!startMarker || !endMarker) return;

let coords=[startMarker.getLatLng()];

stopMarkers.forEach(m=>coords.push(m.getLatLng()));

coords.push(endMarker.getLatLng());

const r=await route(coords);

if(window.routeLine)map.removeLayer(window.routeLine);

window.routeLine=L.geoJSON(r.geometry,{style:{weight:6}}).addTo(map);
map.fitBounds(window.routeLine.getBounds());

meta.innerHTML=`Distanz ${(r.distance/1000).toFixed(1)} km<br>Zeit ${Math.round(r.duration/60)} min`;
}
</script>

</body>
</html>
