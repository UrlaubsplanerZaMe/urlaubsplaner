<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Urlaubsplaner</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
body { margin:0; }
#map { height:100vh; }

.card{
position:absolute;
top:14px;
left:14px;
z-index:1000;
width:340px;
background:rgba(255,255,255,0.95);
border-radius:18px;
padding:14px;
box-shadow:0 16px 40px rgba(0,0,0,0.18);
font-family:-apple-system;
}

.field{width:100%;padding:12px;border-radius:12px;border:1px solid #ddd;margin-bottom:8px;}
.btn{padding:10px;border-radius:12px;border:0;font-weight:700;cursor:pointer;margin-top:6px;width:100%;}
.blue{background:#0a84ff;color:#fff;}
.gray{background:#eee;}
.row{display:flex;gap:6px;margin-bottom:6px;}
.meta{font-size:13px;margin-top:8px;}
</style>
</head>
<body>

<div class="card">

<div class="row">
<button class="btn gray" onclick="setMapMode('start')">üìç Start w√§hlen</button>
<button class="btn gray" onclick="setMapMode('stop')">üü° Stopp w√§hlen</button>
<button class="btn gray" onclick="setMapMode('ziel')">üèÅ Ziel w√§hlen</button>
</div>

<input id="startAddr" class="field" placeholder="Startadresse">

<div id="stops"></div>
<button class="btn gray" onclick="addStop()">+ Stopp</button>

<input id="endAddr" class="field" placeholder="Zieladresse">

<button class="btn blue" onclick="buildRoute()">Route berechnen</button>

<div class="meta" id="meta"></div>

</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const map = L.map('map').setView([51.1657,10.4515],6);

L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

let mapMode = null;

function setMapMode(mode){
mapMode = mode;
}

function addStop(){
const input = document.createElement("input");
input.className="field";
input.placeholder="Stopp";
stops.appendChild(input);
}

let startMarker, endMarker, stopMarkers=[];

map.on("click", async function(e){

if(!mapMode) return;

const addr = await reverseGeocode(e.latlng.lat,e.latlng.lng);

if(mapMode==="start"){
document.getElementById("startAddr").value = addr;
if(startMarker) map.removeLayer(startMarker);
startMarker=L.marker(e.latlng).addTo(map);
}

if(mapMode==="ziel"){
document.getElementById("endAddr").value = addr;
if(endMarker) map.removeLayer(endMarker);
endMarker=L.marker(e.latlng).addTo(map);
}

if(mapMode==="stop"){
addStop();
const inputs=document.querySelectorAll("#stops input");
inputs[inputs.length-1].value=addr;
const m=L.marker(e.latlng).addTo(map);
stopMarkers.push(m);
}

mapMode=null;

});

async function reverseGeocode(lat,lon){
const url=`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`;
const res=await fetch(url);
const data=await res.json();
return data.display_name || lat+","+lon;
}

async function geocode(q){
const url=`https://nominatim.openstreetmap.org/search?format=json&q=${q}`;
const res=await fetch(url);
const data=await res.json();
return {lat:data[0].lat,lon:data[0].lon};
}

async function buildRoute(){

if(!startAddr.value || !endAddr.value) return;

const start=await geocode(startAddr.value);
const end=await geocode(endAddr.value);

let coords=[start];

const stopInputs=document.querySelectorAll("#stops input");

for(const s of stopInputs){
if(s.value){
coords.push(await geocode(s.value));
}
}

coords.push(end);

const c=coords.map(c=>`${c.lon},${c.lat}`).join(";");

const url=`https://router.project-osrm.org/route/v1/driving/${c}?overview=full&geometries=geojson`;

const res=await fetch(url);
const data=await res.json();

const route=data.routes[0];

if(window.routeLine) map.removeLayer(window.routeLine);

window.routeLine=L.geoJSON(route.geometry,{style:{weight:6}}).addTo(map);

map.fitBounds(window.routeLine.getBounds());

meta.innerHTML=`Distanz: ${(route.distance/1000).toFixed(1)} km<br>Zeit: ${Math.round(route.duration/60)} min`;

}
</script>

</body>
</html>
