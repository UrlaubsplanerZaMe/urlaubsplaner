<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Urlaubsplaner</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <!-- Leaflet Routing Machine -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css"/>

  <style>
    body { margin: 0; }
    #map { height: 100vh; }

    .panel{
      position:absolute;
      top:10px;
      left:10px;
      z-index:1000;
      background:rgba(255,255,255,0.95);
      padding:12px;
      border-radius:14px;
      width:240px;
      box-shadow:0 10px 25px rgba(0,0,0,0.2);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .panel h2{
      margin:0 0 10px 0;
      font-size:18px;
    }
    .btn{
      width:100%;
      padding:12px 10px;
      margin:7px 0;
      border:0;
      border-radius:12px;
      font-size:16px;
      cursor:pointer;
      font-weight:600;
    }
    .blue{ background:#1f6feb; color:white; }
    .gray{ background:#e9eef6; color:#111; }
    .red{ background:#d1242f; color:white; }

    .row{ display:flex; gap:8px; margin-top:6px; }
    .chip{
      flex:1;
      padding:10px 8px;
      border-radius:12px;
      border:2px solid transparent;
      background:#f2f4f8;
      font-weight:700;
      cursor:pointer;
    }
    .chip.active{
      background:#111;
      color:#fff;
    }

    .status{
      margin-top:10px;
      padding:10px;
      background:#f7f7f7;
      border-radius:12px;
      font-size:14px;
      line-height:1.3;
    }
    .badge{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      font-weight:800;
      margin-left:6px;
      font-size:12px;
      background:#eee;
    }
  </style>
</head>
<body>

  <div class="panel">
    <h2>Urlaubsplaner</h2>

    <!-- Transport -->
    <div class="row">
      <button class="chip active" id="mCar">üöó Auto</button>
      <button class="chip" id="mBike">üö¥ Fahrrad</button>
      <button class="chip" id="mFoot">üö∂ Zu Fu√ü</button>
    </div>

    <!-- Setzen -->
    <button class="btn blue" id="btnStart">üìç Startpunkt setzen</button>
    <button class="btn gray" id="btnStop">üü° Zwischenstopp setzen</button>
    <button class="btn blue" id="btnZiel">üèÅ Ziel setzen</button>

    <!-- L√∂schen -->
    <button class="btn gray" id="btnClearStops">üßπ Zwischenstopps l√∂schen</button>
    <button class="btn red" id="btnClearAll">üóëÔ∏è Alles l√∂schen</button>

    <div class="status" id="info">
      Modus: <b id="modeText">Startpunkt</b> <span class="badge" id="modeBadge">START</span><br>
      Tipp: Button dr√ºcken ‚Üí dann auf die Karte tippen.<br><br>
      <b>Route:</b><br>
      Distanz: <span id="dist">‚Äì</span><br>
      Zeit: <span id="time">‚Äì</span>
    </div>
  </div>

  <div id="map"></div>

  <!-- JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

  <script>
    // ===== Map =====
    const map = L.map('map').setView([51.505, 10], 6);

    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // ===== State =====
    let mode = "start"; // start | stop | ziel
    let transport = "car"; // car | bicycle | foot

    let startMarker = null;
    let zielMarker  = null;
    let stopMarkers = []; // array of markers

    // ===== UI helpers =====
    const modeText  = document.getElementById("modeText");
    const modeBadge = document.getElementById("modeBadge");
    const distEl    = document.getElementById("dist");
    const timeEl    = document.getElementById("time");

    function setMode(m){
      mode = m;
      if(m === "start"){ modeText.textContent="Startpunkt"; modeBadge.textContent="START"; }
      if(m === "stop"){  modeText.textContent="Zwischenstopp"; modeBadge.textContent="STOP"; }
      if(m === "ziel"){  modeText.textContent="Ziel"; modeBadge.textContent="ZIEL"; }
    }

    function secondsToHMS(sec){
      sec = Math.round(sec);
      const h = Math.floor(sec / 3600);
      const m = Math.floor((sec % 3600) / 60);
      if(h <= 0) return `${m} min`;
      return `${h} h ${m} min`;
    }

    function metersToKM(m){
      return (m/1000).toFixed(1) + " km";
    }

    // ===== Routing (OSRM) =====
    function makeRouter(){
      // OSRM profile: 'car' | 'bicycle' | 'foot'
      return L.Routing.osrmv1({
        serviceUrl: 'https://router.project-osrm.org/route/v1',
        profile: transport
      });
    }

    const routing = L.Routing.control({
      waypoints: [],
      router: makeRouter(),
      addWaypoints: false,
      draggableWaypoints: false,
      fitSelectedRoutes: true,
      show: false,             // kein Seitenpanel von LRM
      routeWhileDragging: false,
      lineOptions: { styles: [{ weight: 6, opacity: 0.9 }] }
    }).addTo(map);

    routing.on('routesfound', function(e){
      const r = e.routes[0];
      distEl.textContent = metersToKM(r.summary.totalDistance);
      timeEl.textContent = secondsToHMS(r.summary.totalTime);
    });

    function updateRoute(){
      if(!startMarker || !zielMarker){
        routing.setWaypoints([]);
        distEl.textContent = "‚Äì";
        timeEl.textContent = "‚Äì";
        return;
      }

      const pts = [];
      pts.push(startMarker.getLatLng());
      stopMarkers.forEach(m => pts.push(m.getLatLng()));
      pts.push(zielMarker.getLatLng());

      routing.setWaypoints(pts);
    }

    // ===== Buttons =====
    document.getElementById("btnStart").onclick = () => setMode("start");
    document.getElementById("btnStop").onclick  = () => setMode("stop");
    document.getElementById("btnZiel").onclick  = () => setMode("ziel");

    document.getElementById("btnClearStops").onclick = () => {
      stopMarkers.forEach(m => map.removeLayer(m));
      stopMarkers = [];
      updateRoute();
    };

    document.getElementById("btnClearAll").onclick = () => {
      if(startMarker) map.removeLayer(startMarker);
      if(zielMarker)  map.removeLayer(zielMarker);
      stopMarkers.forEach(m => map.removeLayer(m));

      startMarker = null;
      zielMarker  = null;
      stopMarkers = [];

      updateRoute();
    };

    // Transport chips
    const mCar  = document.getElementById("mCar");
    const mBike = document.getElementById("mBike");
    const mFoot = document.getElementById("mFoot");

    function setTransport(t){
      transport = t;

      mCar.classList.toggle("active", t === "car");
      mBike.classList.toggle("active", t === "bicycle");
      mFoot.classList.toggle("active", t === "foot");

      // Router austauschen + neu berechnen
      routing.setRouter(makeRouter());
      updateRoute();
    }

    mCar.onclick  = () => setTransport("car");
    mBike.onclick = () => setTransport("bicycle");
    mFoot.onclick = () => setTransport("foot");

    // ===== Click on map =====
    map.on('click', function(e){
      if(mode === "start"){
        if(startMarker) map.removeLayer(startMarker);
        startMarker = L.marker(e.latlng).addTo(map).bindPopup("Start").openPopup();
      }

      if(mode === "stop"){
        const m = L.marker(e.latlng).addTo(map).bindPopup("Stopp");
        stopMarkers.push(m);
        m.openPopup();
      }

      if(mode === "ziel"){
        if(zielMarker) map.removeLayer(zielMarker);
        zielMarker = L.marker(e.latlng).addTo(map).bindPopup("Ziel").openPopup();
      }

      updateRoute();
    });

    // Start-Mode standard
    setMode("start");
    setTransport("car");
  </script>
</body>
</html>
