<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Urlaubsplaner</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    :root{
      --bg: rgba(255,255,255,0.92);
      --border: rgba(0,0,0,0.08);
      --shadow: 0 16px 40px rgba(0,0,0,0.18);
      --text: #0b0f14;
      --sub: rgba(11,15,20,0.65);
      --blue: #0a84ff;
      --chip: rgba(10,132,255,0.12);
    }

    body{ margin:0; }
    #map{ height:100vh; width:100vw; }

    .card{
      position:absolute;
      top:14px; left:14px;
      z-index:1000;
      width:360px;
      max-width: calc(100vw - 28px);
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      font-family: -apple-system, BlinkMacSystemFont, system-ui, Segoe UI, Roboto, Arial, sans-serif;
      overflow:hidden;
    }

    .header{
      padding: 14px 14px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .title{
      font-size: 16px;
      font-weight: 800;
      color: var(--text);
      display:flex;
      align-items:center;
      gap:8px;
    }
    .chip{
      font-size: 12px;
      font-weight: 800;
      padding: 4px 10px;
      border-radius: 999px;
      background: var(--chip);
      color: var(--blue);
      border: 1px solid rgba(10,132,255,0.18);
      white-space: nowrap;
    }
    .content{ padding: 0 14px 14px; }

    label{
      display:block;
      margin: 10px 0 6px;
      font-size: 12px;
      font-weight: 750;
      color: var(--sub);
    }

    .row{ display:flex; gap:8px; }
    .row > * { flex: 1; }

    .field{
      width:100%;
      box-sizing:border-box;
      border: 1px solid rgba(0,0,0,0.10);
      background: rgba(255,255,255,0.96);
      border-radius: 14px;
      padding: 12px 12px;
      font-size: 14px;
      outline:none;
      color: var(--text);
    }
    .field:focus{
      border-color: rgba(10,132,255,0.45);
      box-shadow: 0 0 0 4px rgba(10,132,255,0.12);
    }

    .btn{
      border:0;
      border-radius: 14px;
      padding: 12px 12px;
      cursor:pointer;
      font-weight: 850;
      font-size: 14px;
      background: rgba(0,0,0,0.06);
      color: var(--text);
    }
    .btn:active{ transform: scale(0.99); }
    .primary{ background: var(--blue); color:#fff; }
    .small{ padding: 10px 10px; font-size: 13px; }

    .divider{
      height: 1px;
      background: rgba(0,0,0,0.07);
      margin: 12px 0 10px;
    }

    .meta{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      font-size: 13px;
      color: var(--sub);
      line-height: 1.4;
      background: rgba(255,255,255,0.9);
      border: 1px solid rgba(0,0,0,0.08);
      border-radius: 14px;
      padding: 10px;
    }
    .meta strong{ color: var(--text); }

    .toggle{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: rgba(0,0,0,0.04);
      border: 1px solid rgba(0,0,0,0.06);
      padding: 10px 12px;
      border-radius: 14px;
      cursor: pointer;
      user-select:none;
      font-weight: 900;
      color: var(--text);
      margin-top: 10px;
    }

    .adv{
      display:none;
      margin-top:10px;
      padding: 10px;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,0.08);
      background: rgba(255,255,255,0.9);
    }

    .hint{
      margin-top: 10px;
      font-size: 12.5px;
      color: var(--sub);
    }

    .tripList{
      max-height: 220px;
      overflow:auto;
      background: rgba(0,0,0,0.03);
      border-radius: 14px;
      padding: 8px;
      border: 1px solid rgba(0,0,0,0.06);
    }
    .tripItem{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:space-between;
      padding:10px;
      background: rgba(255,255,255,0.9);
      border: 1px solid rgba(0,0,0,0.07);
      border-radius: 14px;
      margin-bottom: 8px;
    }
    .tripItem:last-child{ margin-bottom:0; }
    .tripName{ font-weight: 900; font-size: 14px; color: var(--text); }
    .tripSub{ font-size: 12px; color: var(--sub); margin-top: 2px; }
    .tripBtns{ display:flex; gap:6px; }
    .pillBtn{ padding: 9px 10px; border-radius: 12px; border:0; font-weight: 900; cursor:pointer; }
    .pillLoad{ background: var(--blue); color:#fff; }
    .pillDel{ background: rgba(255,59,48,0.12); color: #ff3b30; border: 1px solid rgba(255,59,48,0.22); }

    .modeRow{
      display:flex;
      gap:8px;
      margin-top:8px;
    }

    @media (max-width: 380px){
      .card{ width: 340px; }
    }
  </style>
</head>

<body>
  <div class="card">
    <div class="header">
      <div class="title">Urlaubsplaner <span class="chip">ðŸš— Auto</span></div>
      <button class="btn small" onclick="newTrip()">Neu</button>
    </div>

    <div class="content">
      <label>Reise</label>
      <input id="tripName" class="field" placeholder="Name (z.B. Gardasee 2026)" />

      <div class="row" style="margin-top:8px;">
        <input id="dateFrom" class="field" type="date" />
        <input id="dateTo" class="field" type="date" />
      </div>

      <div class="modeRow">
        <button class="btn small" onclick="setMapPickMode('start')">Start wÃ¤hlen</button>
        <button class="btn small" onclick="setMapPickMode('stop')">Zwischenstopp wÃ¤hlen</button>
        <button class="btn small" onclick="setMapPickMode('ziel')">Ziel wÃ¤hlen</button>
      </div>

      <label>Start</label>
      <input id="startAddr" class="field" placeholder="z.B. Brensbach" />

      <label>Ziel</label>
      <input id="endAddr" class="field" placeholder="z.B. Verona" />

      <div class="row" style="margin-top:10px;">
        <button class="btn primary" onclick="buildRoute()">Tag 1 Route berechnen</button>
        <button class="btn" onclick="saveTrip()">Reise speichern</button>
      </div>

      <div class="meta" id="meta">
        <span><strong>Distanz:</strong> â€”</span>
        <span><strong>Zeit:</strong> â€”</span>
        <span><strong>Sprit:</strong> â€”</span>
        <span><strong>Summe:</strong> â€”</span>
      </div>

      <div class="toggle" onclick="toggleAdvanced()">
        <span>Erweiterte Suche</span>
        <span id="advArrow">â–¾</span>
      </div>

      <div class="adv" id="advanced">
        <label>Fahrzeug & Verbrauch</label>
        <div class="row">
          <select id="fuelType" class="field" onchange="applyFuelDefaults(); recalcCosts();">
            <option value="diesel">Diesel</option>
            <option value="benzin">Benzin</option>
          </select>
          <input id="consumption" class="field" type="number" step="0.1" value="6.5" placeholder="l/100km" oninput="recalcCosts()"/>
        </div>

        <label>Spritpreis (â‚¬/l) â€“ manuell</label>
        <div class="row">
          <input id="fuelPrice" class="field" type="number" step="0.001" placeholder="z.B. 1.799" oninput="recalcCosts()"/>
          <button class="btn small" onclick="fillExamplePrices()">Beispiel</button>
        </div>

        <div class="hint" id="fuelHint">
          Du kannst den aktuellen Preis selbst recherchieren und hier eintragen.
        </div>
      </div>

      <div class="divider"></div>

      <label>Gespeicherte Reisen</label>
      <div class="tripList" id="tripList"></div>

      <div class="hint">
        Start/Ziel per Adresse oder Karte wÃ¤hlen. Marker sind verschiebbar â€“ Route berechnet sich neu.
      </div>
    </div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // ====== Storage Keys ======
    const STORAGE_KEY = "urlaubsplaner_trips_v3";

    // ====== Map ======
    const map = L.map('map').setView([49.773, 8.86], 7); // NÃ¤he Hessen grob
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

    // ====== UI ======
    const metaEl = document.getElementById("meta");
    const tripListEl = document.getElementById("tripList");
    const advEl = document.getElementById("advanced");
    const advArrow = document.getElementById("advArrow");

    const tripNameEl = document.getElementById("tripName");
    const dateFromEl = document.getElementById("dateFrom");
    const dateToEl = document.getElementById("dateTo");
    const startAddrEl = document.getElementById("startAddr");
    const endAddrEl = document.getElementById("endAddr");

    const fuelTypeEl = document.getElementById("fuelType");
    const consumptionEl = document.getElementById("consumption");
    const fuelPriceEl = document.getElementById("fuelPrice");
    const fuelHintEl = document.getElementById("fuelHint");

    // ====== State ======
    let pickMode = null; // "start" | "stop" | "ziel"
    let startMarker = null;
    let endMarker = null;
    let stopMarkers = [];
    let routeLine = null;

    let routeKm = 0;
    let routeMin = 0;

    // ====== Helpers ======
    function setMeta(dist, time, fuel, total){
      metaEl.innerHTML = `
        <span><strong>Distanz:</strong> ${dist}</span>
        <span><strong>Zeit:</strong> ${time}</span>
        <span><strong>Sprit:</strong> ${fuel}</span>
        <span><strong>Summe:</strong> ${total}</span>
      `;
    }

    function toggleAdvanced(){
      const show = advEl.style.display !== "block";
      advEl.style.display = show ? "block" : "none";
      advArrow.textContent = show ? "â–´" : "â–¾";
    }

    function setMapPickMode(m){
      pickMode = m;
    }

    function createDraggableMarker(latlng, label, onMoved){
      const m = L.marker(latlng, { draggable:true }).addTo(map).bindPopup(label);
      m.on("dragend", async () => {
        const p = m.getLatLng();
        try{
          const addr = await reverseGeocode(p.lat, p.lng);
          onMoved(addr);
        }catch(e){
          onMoved(`${p.lat.toFixed(6)}, ${p.lng.toFixed(6)}`);
        }
        buildRoute(); // Route + Kosten automatisch aktualisieren
      });
      return m;
    }

    async function reverseGeocode(lat, lon){
      const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`;
      const res = await fetch(url, { headers: { "Accept":"application/json" }});
      const data = await res.json();
      return data.display_name || `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
    }

    async function geocodeOne(q){
      const m = q.match(/^\s*(-?\d+(\.\d+)?)\s*,\s*(-?\d+(\.\d+)?)\s*$/);
      if(m) return { lat: parseFloat(m[1]), lon: parseFloat(m[3]) };

      const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(q)}`;
      const res = await fetch(url, { headers: { "Accept":"application/json" }});
      const data = await res.json();
      if(!data || !data[0]) return null;
      return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
    }

    async function routeOSRM(points){
      const coordStr = points.map(p => `${p.lon},${p.lat}`).join(";");
      const url = `https://router.project-osrm.org/route/v1/driving/${coordStr}?overview=full&geometries=geojson&steps=false`;
      const res = await fetch(url, { headers: { "Accept":"application/json" }});
      const data = await res.json();
      return data.routes && data.routes[0] ? data.routes[0] : null;
    }

    function money(n){
      if(!isFinite(n)) return "â€”";
      return n.toFixed(2) + " â‚¬";
    }

    function applyFuelDefaults(){
      // nur bequeme Defaults (kannst du Ã¤ndern)
      if(fuelTypeEl.value === "diesel"){
        if(!consumptionEl.value) consumptionEl.value = "6.5";
      }else{
        if(!consumptionEl.value) consumptionEl.value = "7.5";
      }
      if(!fuelPriceEl.value) fuelHintEl.textContent = "Trage den aktuellen Preis ein (â‚¬/l).";
    }

    function fillExamplePrices(){
      // nur Beispielwerte, damit du siehst wie es rechnet
      if(fuelTypeEl.value === "diesel") fuelPriceEl.value = "1.799";
      else fuelPriceEl.value = "1.899";
      recalcCosts();
    }

    function recalcCosts(){
      if(routeKm <= 0){
        setMeta("â€”","â€”","â€”","â€”");
        return;
      }

      const cons = parseFloat(consumptionEl.value);
      const price = parseFloat(fuelPriceEl.value);

      const liters = isFinite(cons) ? (routeKm * cons / 100) : NaN;
      const fuelCost = (isFinite(liters) && isFinite(price)) ? (liters * price) : NaN;

      const fuelText =
        (isFinite(liters) ? liters.toFixed(1) + " l" : "â€”") +
        " / " +
        (isFinite(fuelCost) ? money(fuelCost) : "â€”");

      // Ohne GebÃ¼hren ist Summe = Sprit (oder â€”)
      const total = isFinite(fuelCost) ? fuelCost : NaN;

      setMeta(
        routeKm.toFixed(1) + " km",
        Math.round(routeMin) + " min",
        fuelText,
        isFinite(total) ? money(total) : "â€”"
      );
    }

    // ====== Map click pick ======
    map.on("click", async (e) => {
      if(!pickMode) return;

      const addr = await reverseGeocode(e.latlng.lat, e.latlng.lng);

      if(pickMode === "start"){
        startAddrEl.value = addr;
        if(startMarker) map.removeLayer(startMarker);
        startMarker = createDraggableMarker(e.latlng, "Start", a => startAddrEl.value = a);
        startMarker.openPopup();
      }

      if(pickMode === "ziel"){
        endAddrEl.value = addr;
        if(endMarker) map.removeLayer(endMarker);
        endMarker = createDraggableMarker(e.latlng, "Ziel", a => endAddrEl.value = a);
        endMarker.openPopup();
      }

      if(pickMode === "stop"){
        const m = createDraggableMarker(e.latlng, "Zwischenstopp", () => {});
        stopMarkers.push(m);
        m.openPopup();
      }

      pickMode = null;
      buildRoute();
    });

    // ====== Build route day 1 ======
    async function buildRoute(){
      let points = [];

      // 1) Wenn Marker da sind: direkt Marker verwenden
      if(startMarker && endMarker){
        points.push({ lat: startMarker.getLatLng().lat, lon: startMarker.getLatLng().lng });
        for(const sm of stopMarkers){
          const ll = sm.getLatLng();
          points.push({ lat: ll.lat, lon: ll.lng });
        }
        points.push({ lat: endMarker.getLatLng().lat, lon: endMarker.getLatLng().lng });
      } else {
        // 2) Sonst: aus Start/Ziel Text geocoden und Marker erstellen
        const startText = startAddrEl.value.trim();
        const endText = endAddrEl.value.trim();
        if(!startText || !endText){
          routeKm = 0; routeMin = 0;
          setMeta("â€”","â€”","â€”","â€”");
          return;
        }

        const s = await geocodeOne(startText);
        const z = await geocodeOne(endText);
        if(!s || !z){
          routeKm = 0; routeMin = 0;
          setMeta("â€”","â€”","â€”","â€”");
          return;
        }

        points = [s, z];

        // Marker synchronisieren (damit Drag danach klappt)
        if(startMarker) map.removeLayer(startMarker);
        if(endMarker) map.removeLayer(endMarker);
        stopMarkers.forEach(m => map.removeLayer(m));
        stopMarkers = [];

        startMarker = createDraggableMarker([s.lat, s.lon], "Start", a => startAddrEl.value = a);
        endMarker = createDraggableMarker([z.lat, z.lon], "Ziel", a => endAddrEl.value = a);
      }

      const r = await routeOSRM(points);
      if(!r){
        routeKm = 0; routeMin = 0;
        setMeta("â€”","â€”","â€”","â€”");
        return;
      }

      if(routeLine) map.removeLayer(routeLine);
      routeLine = L.geoJSON(r.geometry, { style: { weight: 6, opacity: 0.95 } }).addTo(map);
      map.fitBounds(routeLine.getBounds().pad(0.15));

      routeKm = r.distance / 1000;
      routeMin = r.duration / 60;

      recalcCosts();
    }

    // ====== Trips storage ======
    function loadTrips(){
      try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; }
      catch(e){ return []; }
    }
    function saveTrips(trips){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(trips));
    }

    function tripData(){
      return {
        name: tripNameEl.value.trim(),
        dateFrom: dateFromEl.value || "",
        dateTo: dateToEl.value || "",
        startAddr: startAddrEl.value || "",
        endAddr: endAddrEl.value || "",
        start: startMarker ? startMarker.getLatLng() : null,
        end: endMarker ? endMarker.getLatLng() : null,
        stops: stopMarkers.map(m => m.getLatLng()),
        fuelType: fuelTypeEl.value,
        consumption: parseFloat(consumptionEl.value) || 0,
        fuelPrice: parseFloat(fuelPriceEl.value) || 0,
        updatedAt: Date.now()
      };
    }

    function applyTrip(t){
      tripNameEl.value = t.name || "";
      dateFromEl.value = t.dateFrom || "";
      dateToEl.value = t.dateTo || "";
      startAddrEl.value = t.startAddr || "";
      endAddrEl.value = t.endAddr || "";

      fuelTypeEl.value = t.fuelType || "diesel";
      consumptionEl.value = (t.consumption ?? 6.5);
      fuelPriceEl.value = (t.fuelPrice ?? "");

      // map clear
      if(startMarker) map.removeLayer(startMarker);
      if(endMarker) map.removeLayer(endMarker);
      stopMarkers.forEach(m => map.removeLayer(m));
      stopMarkers = [];
      if(routeLine) map.removeLayer(routeLine);
      routeLine = null;

      startMarker = null;
      endMarker = null;

      if(t.start){
        startMarker = createDraggableMarker(t.start, "Start", a => startAddrEl.value = a);
      }
      if(t.end){
        endMarker = createDraggableMarker(t.end, "Ziel", a => endAddrEl.value = a);
      }
      (t.stops || []).forEach(s => {
        const m = createDraggableMarker(s, "Zwischenstopp", () => {});
        stopMarkers.push(m);
      });

      buildRoute();
    }

    function saveTrip(){
      const data = tripData();
      if(!data.name){
        alert("Bitte Reisename eingeben.");
        return;
      }
      if(!startMarker || !endMarker){
        alert("Bitte Start & Ziel setzen (Adresse oder Karte), dann speichern.");
        return;
      }

      const trips = loadTrips();
      const idx = trips.findIndex(x => (x.name || "").toLowerCase() === data.name.toLowerCase());
      if(idx >= 0) trips[idx] = data;
      else trips.unshift(data);

      saveTrips(trips);
      renderTripList();
      alert("Reise gespeichert.");
    }

    function deleteTrip(name){
      const trips = loadTrips().filter(t => t.name !== name);
      saveTrips(trips);
      renderTripList();
    }

    function loadTrip(name){
      const trips = loadTrips();
      const t = trips.find(x => x.name === name);
      if(!t) return;
      applyTrip(t);
    }

    function renderTripList(){
      const trips = loadTrips();
      tripListEl.innerHTML = "";
      if(!trips.length){
        tripListEl.innerHTML = `<div style="padding:8px; color:rgba(0,0,0,0.55); font-size:13px;">Noch keine Reisen gespeichert.</div>`;
        return;
      }

      for(const t of trips){
        const item = document.createElement("div");
        item.className = "tripItem";

        const left = document.createElement("div");
        left.style.minWidth = "0";
        left.innerHTML = `
          <div class="tripName">${escapeHtml(t.name || "")}</div>
          <div class="tripSub">${escapeHtml(formatRange(t.dateFrom, t.dateTo))}</div>
        `;

        const btns = document.createElement("div");
        btns.className = "tripBtns";

        const b1 = document.createElement("button");
        b1.className = "pillBtn pillLoad";
        b1.textContent = "Laden";
        b1.onclick = () => loadTrip(t.name);

        const b2 = document.createElement("button");
        b2.className = "pillBtn pillDel";
        b2.textContent = "LÃ¶schen";
        b2.onclick = () => deleteTrip(t.name);

        btns.appendChild(b1);
        btns.appendChild(b2);

        item.appendChild(left);
        item.appendChild(btns);
        tripListEl.appendChild(item);
      }
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function formatRange(a,b){
      if(!a && !b) return "â€”";
      if(a && !b) return `ab ${a}`;
      if(!a && b) return `bis ${b}`;
      return `${a} â€“ ${b}`;
    }

    function newTrip(){
      tripNameEl.value = "";
      dateFromEl.value = "";
      dateToEl.value = "";
      startAddrEl.value = "";
      endAddrEl.value = "";
      fuelTypeEl.value = "diesel";
      consumptionEl.value = "6.5";
      fuelPriceEl.value = "";

      if(startMarker) map.removeLayer(startMarker);
      if(endMarker) map.removeLayer(endMarker);
      stopMarkers.forEach(m => map.removeLayer(m));
      stopMarkers = [];
      if(routeLine) map.removeLayer(routeLine);
      routeLine = null;

      startMarker = null;
      endMarker = null;

      routeKm = 0;
      routeMin = 0;
      setMeta("â€”","â€”","â€”","â€”");
      fuelHintEl.textContent = "Du kannst den aktuellen Preis selbst recherchieren und hier eintragen.";
    }

    // init
    setMeta("â€”","â€”","â€”","â€”");
    applyFuelDefaults();
    renderTripList();
  </script>
</body>
</html>
